{"version":3,"sources":["../../../src/visualizations/counter/utils.ts"],"names":["numberFormat","value","decimalPoints","decimalDelimiter","thousandsDelimiter","locale","numeral","localeData","savedDelimiters","delimiters","thousands","decimal","formatString","Number","isFinite","result","format","getRowNumber","index","rowsCount","parseInt","wrappedIndex","Math","abs","formatValue","stringPrefix","stringSuffix","stringDecimal","stringDecChar","stringThouSep","formatTooltip","getCounterData","rows","options","visualizationName","length","countRow","counterColName","targetColName","counterLabel","counterValue","rowNumber","showTrend","targetRowNumber","targetValue","delta","trendPositive","counterValueTooltip","tooltipFormat","targetValueTooltip","formatTargetValue","isValueNumber"],"mappings":"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","sourcesContent":["import { isNumber, isFinite, toString } from \"lodash\";\nimport numeral from \"numeral\";\n\n// TODO: allow user to specify number format string instead of delimiters only\n// It will allow to remove this function (move all that weird formatting logic to a migration\n// that will set number format for all existing counter visualization)\nfunction numberFormat(value: any, decimalPoints: any, decimalDelimiter: any, thousandsDelimiter: any) {\n  // Temporarily update locale data (restore defaults after formatting)\n  const locale = numeral.localeData();\n  const savedDelimiters = locale.delimiters;\n\n  // Mimic old behavior - AngularJS `number` filter defaults:\n  // - `,` as thousands delimiter\n  // - `.` as decimal delimiter\n  // - three decimal points\n  locale.delimiters = {\n    thousands: \",\",\n    decimal: \".\",\n  };\n  let formatString = \"0,0.000\";\n  if ((Number.isFinite(decimalPoints) && decimalPoints >= 0) || decimalDelimiter || thousandsDelimiter) {\n    locale.delimiters = {\n      thousands: thousandsDelimiter,\n      decimal: decimalDelimiter || \".\",\n    };\n\n    formatString = \"0,0\";\n    if (decimalPoints > 0) {\n      formatString += \".\";\n      while (decimalPoints > 0) {\n        formatString += \"0\";\n        decimalPoints -= 1;\n      }\n    }\n  }\n  const result = numeral(value).format(formatString);\n\n  locale.delimiters = savedDelimiters;\n  return result;\n}\n\n// 0 - special case, use first record\n// 1..N - 1-based record number from beginning (wraps if greater than dataset size)\n// -1..-N - 1-based record number from end (wraps if greater than dataset size)\nfunction getRowNumber(index: any, rowsCount: any) {\n  index = parseInt(index, 10) || 0;\n  if (index === 0) {\n    return index;\n  }\n  const wrappedIndex = (Math.abs(index) - 1) % rowsCount;\n  return index > 0 ? wrappedIndex : rowsCount - wrappedIndex - 1;\n}\n\nfunction formatValue(value: any, { stringPrefix, stringSuffix, stringDecimal, stringDecChar, stringThouSep }: any) {\n  if (isNumber(value)) {\n    value = numberFormat(value, stringDecimal, stringDecChar, stringThouSep);\n    return toString(stringPrefix) + value + toString(stringSuffix);\n  }\n  return toString(value);\n}\n\nfunction formatTooltip(value: any, formatString: any) {\n  if (isNumber(value)) {\n    return numeral(value).format(formatString);\n  }\n  return toString(value);\n}\n\nexport function getCounterData(rows: any, options: any, visualizationName: any) {\n  const result = {};\n  const rowsCount = rows.length;\n\n  if (rowsCount > 0 || options.countRow) {\n    const counterColName = options.counterColName;\n    const targetColName = options.targetColName;\n\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterLabel' does not exist on type '{}... Remove this comment to see the full error message\n    result.counterLabel = options.counterLabel || visualizationName;\n\n    if (options.countRow) {\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n      result.counterValue = rowsCount;\n    } else if (counterColName) {\n      const rowNumber = getRowNumber(options.rowNumber, rowsCount);\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n      result.counterValue = rows[rowNumber][counterColName];\n    }\n\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'showTrend' does not exist on type '{}'.\n    result.showTrend = false;\n\n    if (targetColName) {\n      const targetRowNumber = getRowNumber(options.targetRowNumber, rowsCount);\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n      result.targetValue = rows[targetRowNumber][targetColName];\n\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n      if (Number.isFinite(result.counterValue) && isFinite(result.targetValue)) {\n        // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n        const delta = result.counterValue - result.targetValue;\n        // @ts-expect-error ts-migrate(2339) FIXME: Property 'showTrend' does not exist on type '{}'.\n        result.showTrend = true;\n        // @ts-expect-error ts-migrate(2339) FIXME: Property 'trendPositive' does not exist on type '{... Remove this comment to see the full error message\n        result.trendPositive = delta >= 0;\n      }\n    } else {\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n      result.targetValue = null;\n    }\n\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValueTooltip' does not exist on t... Remove this comment to see the full error message\n    result.counterValueTooltip = formatTooltip(result.counterValue, options.tooltipFormat);\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValueTooltip' does not exist on ty... Remove this comment to see the full error message\n    result.targetValueTooltip = formatTooltip(result.targetValue, options.tooltipFormat);\n\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'counterValue' does not exist on type '{}... Remove this comment to see the full error message\n    result.counterValue = formatValue(result.counterValue, options);\n\n    if (options.formatTargetValue) {\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n      result.targetValue = formatValue(result.targetValue, options);\n    } else {\n      // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n      if (isFinite(result.targetValue)) {\n        // @ts-expect-error ts-migrate(2339) FIXME: Property 'targetValue' does not exist on type '{}'... Remove this comment to see the full error message\n        result.targetValue = numeral(result.targetValue).format(\"0[.]00[0]\");\n      }\n    }\n  }\n\n  return result;\n}\n\nexport function isValueNumber(rows: any, options: any) {\n  if (options.countRow) {\n    return true; // array length is always a number\n  }\n\n  const rowsCount = rows.length;\n  if (rowsCount > 0) {\n    const rowNumber = getRowNumber(options.rowNumber, rowsCount);\n    const counterColName = options.counterColName;\n    if (counterColName) {\n      return isNumber(rows[rowNumber][counterColName]);\n    }\n  }\n\n  return false;\n}\n"],"file":"utils.js"}