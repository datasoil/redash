{"version":3,"sources":["../../../src/visualizations/cohort/prepareData.ts"],"names":["momentInterval","weekly","daily","monthly","groupData","sortedData","result","_","each","item","date","groupKey","valueOf","total","parseInt","values","stage","value","prepareDiagonalData","options","timeInterval","grouped","firstStage","min","map","i","stageCount","last","diff","first","lastStage","previousDate","data","group","Math","abs","row","push","prepareSimpleData","stages","max","isDataValid","rawData","columnNames","columns","c","name","rows","length","includes","dateColumn","stageColumn","totalColumn","valueColumn","prepareData","initialDate","parseFloat","sortBy","r","toDate","mode"],"mappings":"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","sourcesContent":["import _ from \"lodash\";\nimport moment from \"moment\";\n\nconst momentInterval = {\n  weekly: \"weeks\",\n  daily: \"days\",\n  monthly: \"months\",\n};\n\nfunction groupData(sortedData: any) {\n  const result = {};\n\n  _.each(sortedData, item => {\n    const date = moment(item.date);\n    const groupKey = date.valueOf();\n    // @ts-expect-error ts-migrate(7053) FIXME: Element implicitly has an 'any' type because expre... Remove this comment to see the full error message\n    result[groupKey] = result[groupKey] || {\n      date,\n      total: parseInt(item.total, 10) || 0,\n      values: {},\n    };\n    // @ts-expect-error ts-migrate(7053) FIXME: Element implicitly has an 'any' type because expre... Remove this comment to see the full error message\n    result[groupKey].values[item.stage] = parseInt(item.value, 10) || null;\n  });\n\n  return _.values(result);\n}\n\nfunction prepareDiagonalData(sortedData: any, options: any) {\n  const timeInterval = options.timeInterval;\n  const grouped = groupData(sortedData);\n  const firstStage = _.min(_.map(sortedData, i => i.stage));\n  // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n  const stageCount = moment(_.last(grouped).date).diff(_.first(grouped).date, momentInterval[timeInterval]);\n  let lastStage = firstStage + stageCount;\n\n  let previousDate: any = null;\n\n  const data: any = [];\n  _.each(grouped, group => {\n    if (previousDate !== null) {\n      // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n      let diff = Math.abs(previousDate.diff(group.date, momentInterval[timeInterval]));\n      while (diff > 1) {\n        const row = [0];\n        for (let stage = firstStage; stage <= lastStage; stage += 1) {\n          // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n          row.push(group.values[stage] || 0);\n        }\n        data.push(row);\n        // It should be diagonal, so decrease count of stages for each next row\n        lastStage -= 1;\n        diff -= 1;\n      }\n    }\n\n    // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n    previousDate = group.date;\n\n    // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n    const row = [group.total];\n    for (let stage = firstStage; stage <= lastStage; stage += 1) {\n      // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n      row.push(group.values[stage] || 0);\n    }\n    // It should be diagonal, so decrease count of stages for each next row\n    lastStage -= 1;\n\n    data.push(row);\n  });\n\n  return data;\n}\n\nfunction prepareSimpleData(sortedData: any, options: any) {\n  const timeInterval = options.timeInterval;\n  const grouped = groupData(sortedData);\n  const stages = _.map(sortedData, i => i.stage);\n  const firstStage = _.min(stages);\n  const lastStage = _.max(stages);\n\n  let previousDate: any = null;\n\n  const data: any = [];\n  _.each(grouped, group => {\n    if (previousDate !== null) {\n      // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n      let diff = Math.abs(previousDate.diff(group.date, momentInterval[timeInterval]));\n      while (diff > 1) {\n        data.push([0]);\n        diff -= 1;\n      }\n    }\n\n    // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n    previousDate = group.date;\n\n    // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n    const row = [group.total];\n    for (let stage = firstStage; stage <= lastStage; stage += 1) {\n      // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\n      row.push(group.values[stage]);\n    }\n\n    data.push(row);\n  });\n\n  return data;\n}\n\nfunction isDataValid(rawData: any, options: any) {\n  const columnNames = _.map(rawData.columns, c => c.name);\n  return (\n    rawData.rows.length > 0 &&\n    _.includes(columnNames, options.dateColumn) &&\n    _.includes(columnNames, options.stageColumn) &&\n    _.includes(columnNames, options.totalColumn) &&\n    _.includes(columnNames, options.valueColumn)\n  );\n}\n\nexport default function prepareData(rawData: any, options: any) {\n  if (!isDataValid(rawData, options)) {\n    return { data: [], initialDate: null };\n  }\n\n  rawData = _.map(rawData.rows, item => ({\n    date: item[options.dateColumn],\n    stage: parseInt(item[options.stageColumn], 10),\n    total: parseFloat(item[options.totalColumn]),\n    value: parseFloat(item[options.valueColumn]),\n  }));\n  const sortedData = _.sortBy(rawData, r => r.date + r.stage);\n  const initialDate = moment(sortedData[0].date).toDate();\n\n  let data;\n  switch (options.mode) {\n    case \"simple\":\n      data = prepareSimpleData(sortedData, options);\n      break;\n    default:\n      data = prepareDiagonalData(sortedData, options);\n      break;\n  }\n\n  return { data, initialDate };\n}\n"],"file":"prepareData.js"}